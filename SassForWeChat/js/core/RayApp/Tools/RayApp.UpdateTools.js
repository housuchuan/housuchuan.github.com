define(function(require,x,c){var l=require("CommonTools_Core");var p=require("FileTools_Core");var i=require("DownLoadTools_Core");var u=require("NotificationTools_Core");var j={isDebug:true,timeout:10,retry:1,retryInterval:1,updateUrl:"",UpdateUrl:"",localUpdateFileDir:"update",localUpdateFile:"update.json",localUpdatePackageFileDir:"_downloads/update/",defaultshowInfoTitle:"更新提示",defaultshowInfoDetail:"有新版本拉！",defaultconfirmBtn:"立即更新",defaultcancelBtn:"下次再说"};var t="";var h="";var f="";var m=null;var e=false;var w=null;function r(y,z){plus.io.resolveLocalFileSystemURL(j.localUpdatePackageFileDir,function(A){if(y&&typeof(y)=="function"){y(A)}},function(A){plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS,function(B){B.root.getDirectory(j.localUpdateFileDir,{create:true},function(C){if(y&&typeof(y)=="function"){y(C)}},function(C){z&&z("打开update目录失败..."+C.message)})},function(B){z&&z("打开download目录失败..."+B.message)})})}function s(z,B,y,A){if(m==null){r(function(C){m=C;s(z,B,y)})}m.getFile(z,{create:true},function(C){o(C,B,function(){if(y&&typeof(y)=="function"){y()}},A)},function(C){A&&A("写入数据，打开保存文件失败："+C.message)})}function o(A,B,y,z){if(!A||A.isFile==false){z&&z("目标文件对象有误!");return}A.createWriter(function(C){C.onerror=function(){z&&z("写入数据，保存文件失败！")};C.write(B);if(y&&typeof(y)=="function"){y()}},function(C){z&&z("创建写文件对象失败："+C.message)})}function v(A,y,z){if(!A||A.isFile==false){z&&z("目标文件对象有误");return}A.file(function(C){var B=new plus.io.FileReader();B.onloadend=function(E){var D=null;try{D=JSON.parse(E.target.result)}catch(E){z&&z("读取本地升级文件，数据格式错误！"+E)}if(y&&typeof(y)=="function"){y(D)}};B.readAsText(C)},function(B){z&&z("读取本地升级文件，获取文件对象失败："+B.message);A.remove()})}function d(B){var z=j.localUpdatePackageFileDir+j.localUpdateFile;if(j.isDebug==true){console.log("更新文件本地路径:"+z+",服务器地址:"+j.updateUrl)}p.delFile(z);var y=j;y.getRelativePathFromLoadUrlCallback=function(){return z};i.setOptions(y);var A=j.updateUrl||j.UpdateUrl;i.downloadFileWidthLocalCache(A,{beforeDownload:function(){B&&B.beforeDownloadJson&&B.beforeDownloadJson()},successDownload:function(C){if(j.isDebug==true){console.log("成功下载更新文件:"+C)}a(B)},errorDownload:function(C){B&&B.errorUpdate&&B.errorUpdate("请求更新信息文件时:"+C)}},false)}function a(y){if(m==null){y&&y.errorUpdate&&y.errorUpdate("下载后本地更新文件不存在,请检查写入权限");return}m.getFile(j.localUpdateFile,{create:false},function(z){v(z,function(A){if(A!=null){q(A,y)}else{y&&y.errorUpdate&&y.errorUpdate("读取更新文件时出错,造成了空值!")}},function(A){y&&y.errorUpdate&&y.errorUpdate(A)})},function(z){y&&y.errorUpdate&&y.errorUpdate("更新文件下载错误..."+z.message)})}function q(y,z){if(j.isDebug==true){console.log("检查应用包版本,当前版本:"+x.getCurrentAppVersion()+",新的版本:"+y[plus.os.name].AppVersion);console.log("检查资源包版本,当前资源包版本:"+t+",新的资源包:"+y[plus.os.name].ResourcePackage.resourceVersion)}if(y&&y[plus.os.name]&&y[plus.os.name].ResourcePackage){if(l.compareVersion(x.getCurrentAppVersion(),y[plus.os.name].AppVersion)==true){n(y,true,z)}else{if(l.compareVersion(t,y[plus.os.name].ResourcePackage.resourceVersion)==true){n(y,false,z)}else{z&&z.errorUpdate&&z.errorUpdate("当前已经是最新版本",0)}}}else{z&&z.errorUpdate&&z.errorUpdate("更新文件格式有误...")}}function n(C,z,E){var A=j.defaultshowInfoTitle;var B=j.defaultshowInfoDetail;var y=j.defaultconfirmBtn;var D=j.defaultcancelBtn;if(z==true){A=C[plus.os.name].InfoTitle?C[plus.os.name].InfoTitle:A;B=C[plus.os.name].InfoDetail?C[plus.os.name].InfoDetail:B}else{A=C[plus.os.name].ResourcePackage.InfoTitle?C[plus.os.name].ResourcePackage.InfoTitle:A;B=C[plus.os.name].ResourcePackage.InfoDetail?C[plus.os.name].ResourcePackage.InfoDetail:B}plus.ui.confirm(B,function(F){if(0==F.index){e=false;g(C,z,E)}else{E&&E.errorUpdate&&E.errorUpdate("取消更新,下次再升级",2);if(C.IsMust=="1"){if(plus.os.name=="Android"){plus.nativeUI.alert("注意!升级后才能正常使用!",function(){plus.runtime.quit()})}else{if(z==false){plus.nativeUI.alert("注意!升级后才能正常使用!",function(){plus.runtime.quit()})}}}}},A,[y,D])}function g(A,y,B){var z="";if(y==true){z=A[plus.os.name].AppUrl;if(plus.os.name=="iOS"){if(!A[plus.os.name].AppUrl||A[plus.os.name].AppUrl==""){B&&B.errorUpdate&&B.errorUpdate("新版本地址错误,请检查更新文件...");return}plus.runtime.openURL(A[plus.os.name].AppUrl);return}else{if(!A[plus.os.name].AppUrl||A[plus.os.name].AppUrl==""){B&&B.errorUpdate&&B.errorUpdate("新版本地址错误,请检查更新文件...");return}}}else{if(!A[plus.os.name].ResourcePackage.resourceUrl||A[plus.os.name].ResourcePackage.resourceUrl==""){B&&B.errorUpdate&&B.errorUpdate("新的资源包地址错误,请检查更新文件...");return}z=A[plus.os.name].ResourcePackage.resourceUrl}j.getRelativePathFromLoadUrlCallback=null;i.restoreOptions();i.setOptions(j);w=z;i.downloadFileWidthLocalCache(w,{beforeDownload:function(){B&&B.beforeDownloadFile&&B.beforeDownloadFile()},successDownload:function(C){h=t;f=x.getCurrentAppVersion();if(e==false){setTimeout(b(C,A,y,B),3000)}},errorDownload:function(C){B&&B.errorUpdate&&B.errorUpdate("下载更新包时:"+C)},downloading:function(D,C){B&&B.downloadingFile&&B.downloadingFile(D,C)}},false)}function b(A,z,y,B){if(e==true){B&&B.errorUpdate&&B.errorUpdate("安装更新包失败！已经被手动取消!");return}B&&B.beforeInstall&&B.beforeInstall("在线升级，安装更新文件...");plus.runtime.install(A,{force:true},function(C){var D="default.json";if(y==true){D="updateHistory_typeApp_"+f+"_"+z[plus.os.name].AppVersion+".json"}else{D="updateHistory_typeResource_"+x.getCurrentAppid()+"_"+h+"_"+z[plus.os.name].ResourcePackage.resourceVersion+".json"}if(e==false){s(D,JSON.stringify(z),function(){B&&B.successWriteUpdateHistory&&B.successWriteUpdateHistory("写入更新历史成功")},function(E){B&&B.errorWriteUpdateHistory&&B.errorWriteUpdateHistory(E)});i.restoreOptions();B&&B.successUpdate&&B.successUpdate("应用资源更新完成,重启后生效!")}},function(E){p.delFile(A);var D=E?E.code:"未知错误";var C=E?E.message:"未知错误";B&&B.errorUpdate&&B.errorUpdate("安装更新文件失败["+D+"]:"+C)})}x.setOptions=function(y){if(!y){return}for(var z in j){if(y[z]!==undefined){j[z]=y[z]}}};x.getCurrentAppid=function(){return plus.runtime.appid};x.getCurrentAppVersion=function(){return plus.runtime.version};x.getCurrentResourceVersion=function(y){l.plusReady(function(){plus.runtime.getProperty(x.getCurrentAppid(),function(z){t=z.version;if(y&&typeof(y)=="function"){y(z)}})})};x.abortUpdate=function(){if(w){i.abortTaskByUrl(w)}var y=j.updateUrl||j.UpdateUrl;i.abortTaskByUrl(y)};x.initUpdate=function(y){l.plusReady(function(){x.getCurrentResourceVersion();r(function(z){m=z;d(y)},function(z){y&&y.errorUpdate&&y.errorUpdate(z)})})};x.initUpdateWithDefaultType=function(A){var C=null;var z=false;var y=null;function D(){if(z==false){x.abortUpdate();y&&y.compProgressNotification("终止更新","已经终止更新","更新提示");mui.toast("已经手动终止更新！")}}var B={beforeDownloadJson:function(){if(A==1){y=u.initNotificationControl();y.setNotification("检查更新","正在检查更新信息","更新提示");if(plus.os.name=="iOS"){mui.toast("正在检查更新信息")}}else{C=plus.nativeUI.showWaiting("正在检查更新文件",{back:"close",padlock:true});C.onclose=function(){}}},beforeDownloadFile:function(){if(A==1){y&&y.setNotification("准备更新","准备开始下载更新文件","更新提示");if(plus.os.name=="iOS"){mui.toast("正在后台下载更新包...")}}else{if(C){C.close()}C=plus.nativeUI.showWaiting("准备下载更新包",{back:"close",padlock:true});C.onclose=D}},downloadingFile:function(F,E){if(A==1){y&&y.setProgress(parseInt(F),"正在更新","正在后台下载更新文件","更新提示")}else{if(C){C.setTitle(parseInt(F)+"%,"+E)}}if(F>=100){z=true}},beforeInstall:function(E){if(A==1){y&&y.compProgressNotification("安装更新","正在安装更新文件","更新提示");if(plus.os.name=="iOS"){mui.toast("正在安装更新包...")}}else{if(C){C.setTitle("正在安装更新包...")}}},successUpdate:function(E){z=true;y&&y.setNotification("更新完毕","更新文件已经安装完毕","更新提示");if(C){C.close()}plus.nativeUI.confirm(E,function(F){if(0==F.index){y&&y.clearNotification();plus.runtime.restart()}},"更新成功",["立即重启","手动重启"])},errorUpdate:function(G,F,E){z=true;if(C){C.close()}if(F==0){mui.toast("已经是最新版本!")}else{if(F==1){mui.alert("请前往appstore下载:"+E,"ios更新","我知道了")}else{if(F==2){}else{mui.alert(G,"更新失败","我知道了");y&&y.clearNotification()}}}}};x.initUpdate(B)}});