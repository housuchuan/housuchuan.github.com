define(function(require,exports,module){"use strict;";var t=require("CommonTools_Core");EVENT_START="touchstart",EVENT_MOVE="touchmove",EVENT_END="touchend",EVENT_CANCEL="touchcancel";var i="beforeChangeOffset",e="afterChangeOffset",n="pullstart",s="pulling",l=i,o=e,r="dragEndAfterChangeOffset",a="mui-transitioning",p="mui-pull-top-tips",u="mui-pull-bottom-tips",h="mui-pull-loading",d="mui-scroll",c="mui-pull-loading mui-icon mui-icon-pulldown",g=c+" mui-reverse",f="mui-pull-loading mui-spinner",m="mui-hidden",T="."+h,v={down:{height:75,callback:t.noop},up:{auto:!1,offset:100,show:!0,contentdown:"上拉显示更多",contentrefresh:"正在加载...",contentnomore:"没有更多数据了",callback:t.noop},preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT)$/},element:"#pullrefresh"},w=t.Class.extend({init:function(e,n){"object"!=typeof e?this.element=e:(n=e,this.element=n.element),this.element=this.element||v.element,"string"==typeof this.element&&(this.element=document.querySelector(this.element)),this.element.classList.contains(d)||(this.element=this.element.querySelector("."+d)),mui(this.element.parentNode).scroll({indicators:!0}),this.options=t.extend(!0,{},v,n),this.stopped=this.isNeedRefresh=this.isDragging=!1,this.state=i,this.isInScroll=this.element.classList.contains(d),this.initPullUpTips(),this.initEvent(),this.options.up&&this.options.up.auto&&this.pullupLoading()},_preventDefaultException:function(t,i){for(var e in i)if(i[e].test(t[e]))return!0;return!1},initEvent:function(){this.options.down&&t.isFunction(this.options.down.callback)&&(this.element.addEventListener(EVENT_START,this),this.element.addEventListener("drag",this),this.element.addEventListener("dragend",this)),this.pullUpTips&&(this.element.addEventListener("dragup",this),this.isInScroll?this.element.addEventListener("scrollbottom",this):window.addEventListener("scroll",this))},handleEvent:function(t){switch(t.type){case EVENT_START:this.isInScroll&&this._canPullDown()&&t.target&&!this._preventDefaultException(t.target,this.options.preventDefaultException)&&t.preventDefault();break;case"drag":this._drag(t);break;case"dragend":this._dragend(t);break;case"webkitTransitionEnd":this._transitionEnd(t);break;case"dragup":case"scroll":this._dragup(t);break;case"scrollbottom":this.pullupLoading(t)}},initPullDownTips:function(){var i=this;i.options.down&&t.isFunction(i.options.down.callback)&&(i.pullDownTips=function(){var t=document.querySelector("."+p);return t&&t.parentNode.removeChild(t),t||(t=document.createElement("div"),t.classList.add(p),t.innerHTML='<div class="mui-pull-top-wrapper"><span class="mui-pull-loading mui-icon mui-icon-pulldown"></span></div>',t.addEventListener("webkitTransitionEnd",i)),i.pullDownTipsIcon=t.querySelector(T),document.body.appendChild(t),t}())},initPullUpTips:function(){var i=this;i.options.up&&t.isFunction(i.options.up.callback)&&(i.pullUpTips=function(){var t=i.element.querySelector("."+u);return t||(t=document.createElement("div"),t.classList.add(u),i.options.up.show||t.classList.add(m),t.innerHTML='<div class="mui-pull-bottom-wrapper"><span class="mui-pull-loading">'+i.options.up.contentdown+"</span></div>",i.element.appendChild(t)),i.pullUpTipsIcon=t.querySelector(T),t}())},_transitionEnd:function(t){t.target===this.pullDownTips&&this.removing&&this.removePullDownTips()},_dragup:function(t){var i=this;if(!i.loading){if(t&&t.detail&&mui.gestures.session.drag)i.isDraggingUp=!0;else if(!i.isDraggingUp)return;i.isDragging||i._canPullUp()&&i.pullupLoading(t)}},_canPullUp:function(){if(this.removing)return!1;if(this.isInScroll){var t=this.element.parentNode.getAttribute("data-scroll");if(t){var i=mui.data[t];return i.y===i.maxScrollY}}return window.pageYOffset+window.innerHeight+this.options.up.offset>=document.documentElement.scrollHeight},_canPullDown:function(){if(this.removing)return!1;if(this.isInScroll){var t=this.element.parentNode.getAttribute("data-scroll");if(t){var i=mui.data[t];return 0===i.y}}return 0===document.body.scrollTop},_drag:function(t){if(this.loading||this.stopped)return t.stopPropagation(),void t.detail.gesture.preventDefault();var n=t.detail;if(!this.isDragging&&"down"===n.direction&&this._canPullDown()){if(document.querySelector("."+p))return t.stopPropagation(),void t.detail.gesture.preventDefault();this.isDragging=!0,this.removing=!1,this.startDeltaY=n.deltaY,mui.gestures.session.lockDirection=!0,mui.gestures.session.startDirection=n.direction,this._pullStart(this.startDeltaY)}if(this.isDragging){t.stopPropagation(),t.detail.gesture.preventDefault();var s=n.deltaY-this.startDeltaY;s=Math.min(s,1.5*this.options.down.height),this.deltaY=s,this._pulling(s);var l=s>this.options.down.height?e:i;if(this.state!==l&&(this.state=l,this.state===e?(this.removing=!1,this.isNeedRefresh=!0):(this.removing=!0,this.isNeedRefresh=!1),this["_"+l](s)),mui.os.ios&&parseFloat(mui.os.version)>=8){var o=n.gesture.touches[0].clientY;if(o+10>window.innerHeight||o<10)return void this._dragend(t)}}},_dragend:function(t){var i=this;i.isDragging&&(i.isDragging=!1,i._dragEndAfterChangeOffset(i.isNeedRefresh)),i.isPullingUp&&(i.pullingUpTimeout&&clearTimeout(i.pullingUpTimeout),i.pullingUpTimeout=setTimeout(function(){i.isPullingUp=!1},1e3))},_pullStart:function(t){this.pullStart(t),mui.trigger(this.element,n,{api:this,startDeltaY:t})},_pulling:function(t){this.pulling(t),mui.trigger(this.element,s,{api:this,deltaY:t})},_beforeChangeOffset:function(t){this.beforeChangeOffset(t),mui.trigger(this.element,l,{api:this,deltaY:t})},_afterChangeOffset:function(t){this.afterChangeOffset(t),mui.trigger(this.element,o,{api:this,deltaY:t})},_dragEndAfterChangeOffset:function(t){this.dragEndAfterChangeOffset(t),mui.trigger(this.element,r,{api:this,isNeedRefresh:t})},removePullDownTips:function(){if(this.pullDownTips)try{this.pullDownTips.parentNode&&this.pullDownTips.parentNode.removeChild(this.pullDownTips),this.pullDownTips=null,this.removing=!1}catch(t){}},pullStart:function(t){this.initPullDownTips(t)},pulling:function(t){this.pullDownTips.style.webkitTransform="translate3d(0,"+t+"px,0)"},beforeChangeOffset:function(t){this.pullDownTipsIcon.className=c},afterChangeOffset:function(t){this.pullDownTipsIcon.className=g},dragEndAfterChangeOffset:function(t){t?(this.pullDownTipsIcon.className=f,this.pulldownLoading()):(this.pullDownTipsIcon.className=c,this.endPullDownToRefresh())},pulldownLoading:function(){if(!this.loading){if(!this.pullDownTips)return this.initPullDownTips(),void this.dragEndAfterChangeOffset(!0);this.loading=!0,this.pullDownTips.classList.add(a),this.pullDownTips.style.webkitTransform="translate3d(0,"+this.options.down.height+"px,0)",this.options.down.callback.apply(this)}},pullupLoading:function(t){this.loading||this.finished||(this.loading=!0,this.isDraggingUp=!1,this.pullUpTips&&(this.pullUpTips.classList.remove(m),t&&t.detail&&t.detail.gesture&&t.detail.gesture.preventDefault(),this.pullUpTipsIcon.innerHTML=this.options.up.contentrefresh,this.options.up.callback.apply(this)))},endPullDownToRefresh:function(){this.loading=!1,this.pullUpTips&&this.pullUpTips.classList.remove(m),this.pullDownTips.classList.add(a),this.pullDownTips.style.webkitTransform="translate3d(0,0,0)",this.deltaY<=0?this.removePullDownTips():this.removing=!0,this.isInScroll&&mui(this.element.parentNode).scroll().refresh()},endPullUpToRefresh:function(t){t?(this.finished=!0,this.pullUpTipsIcon.innerHTML=this.options.up.contentnomore,this.element.removeEventListener("dragup",this),window.removeEventListener("scroll",this)):this.pullUpTipsIcon.innerHTML=this.options.up.contentdown,this.loading=!1,this.isInScroll&&mui(this.element.parentNode).scroll().refresh()},setStopped:function(t){t!=this.stopped&&(this.stopped=t,this.pullUpTips&&this.pullUpTips.classList[t?"add":"remove"](m))},refresh:function(t){t&&this.finished&&this.pullUpTipsIcon&&(this.pullUpTipsIcon.innerHTML=this.options.up.contentdown,this.element.addEventListener("dragup",this),window.addEventListener("scroll",this),this.finished=!1)}});exports.PullToRefresh=w,exports.initPullToRefresh=function(t,i){var e=new exports.PullToRefresh(t,i);return e}});