define(function(require,exports,module){"use strict";function e(e){l?e&&e(l):require.async("DownLoadTools_Core",function(t){l=t,e&&e(l)})}function t(e){var t=e.substring(e.lastIndexOf(".")+1,e.length);"jpg"!=t.toLocaleLowerCase()&&"jpeg"!=t.toLocaleLowerCase()&&"png"!=t.toLocaleLowerCase()&&"bmp"!=t.toLocaleLowerCase()&&"svg"!=t.toLocaleLowerCase()&&"gif"!=t.toLocaleLowerCase()&&(t="jpg");var o=/[&\|\\\*^%$#@\-:.?\/=!]/g,a=e.replace(o,"");a=a.trim(),a.length>100&&(a=a.substr(a.length-100,a.length));var n=a+"."+t,l=i.downloadStoragePath+n;return l}function o(e,t,o){e&&e instanceof HTMLElement&&(t==r&&1==i.isUseMinLoading?e.style.maxWidth="30px":e.style.maxWidth="100%",o||(t=c.changImgUrlTypeWithRandomKey(t)),"img"==e.tagName.toLocaleLowerCase()?e.setAttribute("src",t):e.style.backgroundImage="url("+t+")")}function a(e,t){var o=document.documentElement.clientHeight;document.body.scrollTop;o=o;var a=e.getBoundingClientRect().top,n=e.offsetHeight;if(a<o+n&&a+n>=0){var l=e.getAttribute("data-img-localcache");e.getAttribute("src")||exports.setImgWidthLocalCache(e,l,t)}}function n(e){var t=document.querySelectorAll("img"),o=document.querySelectorAll(".img-localcache-background");c.each(t,function(t,o){a(this,e)}),c.each(o,function(t,o){a(this,e)})}var l,c=require("CommonTools_Core"),i={downloadStoragePath:"_downloads/imgs/",fileCacheTimeStamp:864e5,concurrentDownloadCount:3,timeout:3,retryInterval:3,maxTimeSingleDownloadTaskSpend:1e4,defaultImgBase:c.getProjectBasePath()+"img/RayApp/",loadingImgName:"img_loading.jpg",errorImgName:"img_error.jpg",isUseMinLoading:!1,getRelativePathFromLoadUrlCallback:t},r=i.defaultImgBase+i.loadingImgName,g=i.defaultImgBase+i.errorImgName;exports.setOptions=function(e){if(e){for(var t in i)null!=e[t]&&(i[t]=e[t]);r=i.defaultImgBase+i.loadingImgName,g=i.defaultImgBase+i.errorImgName}},exports.clearLoaderImgsCache=function(t,o){e(function(e){e.setOptions(i),e.clearAllLocalFileCache(),e.restoreOptions()})},exports.clearNetUrlImgCache=function(t,o,a){e(function(e){e.clearNetUrlFileCache(t,o,a)})},exports.setImgWidthLocalCache=function(t,a,n){null!=a&&(window.plus&&!n?e(function(e){e.setOptions(i),e.downloadFileWidthLocalCache(a,{beforeDownload:function(){o(t,r)},successDownload:function(e,a){1==a?c.plusReady(function(){var a=plus.io.convertLocalFileSystemURL(e);o(t,a)}):o(t,g)},errorDownload:function(e){o(t,g)}})}):(o(t,r),a?(o(t,a,!0),t.onerror=function(){this.src=g}):o(t,g)))},exports.setAllNetImgsWithLocalCache=function(){var e=document.querySelectorAll("img");c.each(e,function(e,t){var o=this.getAttribute("data-img-localcache");null!=o&&""!=o&&exports.setImgWidthLocalCache(this,o)});var t=document.querySelectorAll(".img-localcache-background");c.each(t,function(e,t){var o=this.getAttribute("data-img-localcache");null!=o&&""!=o&&exports.setImgWidthLocalCache(this,o)})},exports.lazyLoadAllImg=function(e){var t=function(){n(e)};n(e),document.onscroll=t,t()}});