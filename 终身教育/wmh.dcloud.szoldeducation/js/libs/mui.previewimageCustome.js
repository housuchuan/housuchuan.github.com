(function(){var a='<div id="{{id}}" class="mui-slider mui-preview-image mui-fullscreen"><div class="mui-preview-header">{{header}}</div><div class="mui-slider-group"></div><div class="mui-preview-footer mui-hidden">{{footer}}</div><div class="mui-preview-loading"><span class="mui-spinner mui-spinner-white"></span></div></div>';var e='<div class="mui-slider-item mui-zoom-wrapper {{className}}"><div class="mui-zoom-scroller"><img src="{{src}}" data-preview-lazyload="{{lazyload}}" style="{{style}}" class="mui-zoom"></div></div>';var c="__DEFAULT";var g=document.createElement("div");var d=function(h){this.options=mui.extend(true,{id:"__MUI_PREVIEWIMAGE",zoom:true,header:'<span class="mui-preview-indicator"></span>',footer:""},h||{});this.init();this.initEvent()};var b=d.prototype;b.init=function(){var h=this.options;var i=document.getElementById(this.options.id);if(!i){g.innerHTML=a.replace(/\{\{id\}\}/g,this.options.id).replace("{{header}}",h.header).replace("{{footer}}",h.footer);document.body.appendChild(g.firstElementChild);i=document.getElementById(this.options.id)}this.closeCallback=this.options.closeCallback||function(){};this.allImgsData=this.options.allImgsData||null;mui.options.gestureConfig.pinch=true;mui.options.gestureConfig.doubletap=true;this.element=i;this.scroller=this.element.querySelector(mui.classSelector(".slider-group"));this.indicator=this.element.querySelector(mui.classSelector(".preview-indicator"));this.loader=this.element.querySelector(mui.classSelector(".preview-loading"));if(h.footer){this.element.querySelector(mui.classSelector(".preview-footer")).classList.remove(mui.className("hidden"))}this.addImages()};b.initEvent=function(){var i=this;var h=null;this.loader.addEventListener("tap",function(j){console.log("点击loader");h=mui.later(function(){i.close()},300)});this.scroller.addEventListener("tap",function(){console.log("点击scroller");h=mui.later(function(){i.close()},300)});this.scroller.addEventListener("doubletap",function(){console.log("双击");h&&h.cancel();h=null});this.element.addEventListener("slide",function(l){if(i.options.zoom){var k=i.element.querySelector(".mui-zoom-wrapper:nth-child("+(i.lastIndex+1)+")");if(k){mui(k).zoom().setZoom(1)}}var j=l.detail.slideNumber;i.lastIndex=j;console.log("开始slide,slideNumber:"+j);i.indicator&&(i.indicator.innerText=(j+1)+"/"+i.currentGroup.length);i._loadItem(j)})};b.addImages=function(k){this.groups={};var l=[];if(this.allImgsData&&this.allImgsData[k]){l=this.allImgsData[k]}console.log("当前组的数据:"+JSON.stringify(l));if(l.length>0){for(var j=0,h=l.length;j<h;j++){this.addImage(l[j],k)}}};b.addImage=function(i,k){k=k||c;if(!this.groups[k]){this.groups[k]=[]}if(i.__mui_img_data){this.groups[k].push(i.__mui_img_data)}else{var l=i.FileContent;var h=i.FileContent;if(!h){h=l}var j={src:l,lazyload:l===h?"":h,loaded:l===h?true:false,sWidth:0,sHeight:0,sTop:0,sLeft:0,sScale:1,el:null};this.groups[k].push(j);i.__mui_img_data=j;console.log("img的数据:"+JSON.stringify(i))}};b.empty=function(){this.scroller.innerHTML=""};b.openByGroup=function(h,i){h=Math.min(Math.max(0,h),this.groups[i].length-1);console.log("打开分组,index:"+h+",组名:"+i);this.refresh(h,this.groups[i])};b._initImgData=function(h,j){console.log("初始化图片数据:"+JSON.stringify(h));if(!h.sWidth){var i=h.el;h.sWidth=100;h.sHeight=0;var k={sTop:0,sLeft:0};h.sTop=k.top;h.sLeft=k.left;h.sScale=Math.max(h.sWidth/window.innerWidth,h.sHeight/window.innerHeight)}j.style.webkitTransform="translate3d(0,0,0) scale("+h.sScale+")"};b.refresh=function(p,v){this.currentGroup=v;console.log("当前分组数据:"+JSON.stringify(this.currentGroup));var j=v.length;var m=[];var o=this.getRangeByIndex(p,j);var t=o.from;var u=o.to+1;console.log("range,from:"+t+",to:"+u);var q=p;var r="";var w="";var l=window.innerWidth;var s=window.innerHeight;for(var n=0;t<u;t++,n++){var k=v[t];var h="";if(k.sWidth){h="-webkit-transform:translate3d(0,0,0) scale("+k.sScale+");transform:translate3d(0,0,0) scale("+k.sScale+")"}w=e.replace("{{src}}",k.src).replace("{{lazyload}}",k.lazyload).replace("{{style}}",h);if(t===p){q=n;r=mui.className("active")}else{r=""}m.push(w.replace("{{className}}",r))}this.scroller.innerHTML=m.join("");this.element.classList.add(mui.className("preview-in"));this.lastIndex=q;this.element.offsetHeight;mui(this.element).slider().gotoItem(q,0);this.indicator&&(this.indicator.innerText=(q+1)+"/"+this.currentGroup.length);this._loadItem(q)};b._getScale=function(l,k){var i=l.width/k.width;var h=l.height/k.height;var j=1;if(i<=h){j=l.height/(k.height*i)}else{j=l.width/(k.width*h)}return j};b._imgTransitionEnd=function(i){var h=i.target;h.classList.remove(mui.className("transitioning"));h.removeEventListener("webkitTransitionEnd",this._imgTransitionEnd.bind(this))};b._closeTransitionEnd=function(i){var h=i.target;h.classList.remove(mui.className("transitioning"));h.removeEventListener("webkitTransitionEnd",this._closeTransitionEnd.bind(this));this.element.classList.remove(mui.className("preview-in"));this.element.classList.remove(mui.className("transitioning"))};b._loadItem=function(j,m){var k=this.scroller.querySelector(mui.classSelector(".slider-item:nth-child("+(j+1)+")"));var h=this.currentGroup[j];var l=k.querySelector("img");this._initImgData(h,l);if(!h.loaded&&l.getAttribute("data-preview-lazyload")){var i=this;i.loader.classList.add(mui.className("active"));l&&this.loadImage(l,function(){h.loaded=true;l.src=h.lazyload;i._initZoom(k,this.width,this.height);l.classList.add(mui.className("transitioning"));l.addEventListener("webkitTransitionEnd",i._imgTransitionEnd.bind(i));l.setAttribute("style","");l.offsetHeight;m&&m.call(k);i.loader.classList.remove(mui.className("active"))})}else{h.lazyload&&(l.src=h.lazyload);this._initZoom(k,l.width,l.height);l.classList.add(mui.className("transitioning"));l.addEventListener("webkitTransitionEnd",this._imgTransitionEnd.bind(this));l.setAttribute("style","");l.offsetHeight;m&&m.call(k)}this._preloadItem(j+1);this._preloadItem(j-1)};b._preloadItem=function(i){var j=this.scroller.querySelector(mui.classSelector(".slider-item:nth-child("+(i+1)+")"));if(j){var h=this.currentGroup[i];if(!h.sWidth){var k=j.querySelector("img");this._initImgData(h,k)}}};b._initZoom=function(j,m,l){if(!this.options.zoom){return}if(j.getAttribute("data-zoomer")){return}var k=j.querySelector(mui.classSelector(".zoom"));if(k.tagName==="IMG"){var i=this;var h=i._getScale({width:j.offsetWidth,height:j.offsetHeight},{width:m,height:l});mui(j).zoom({maxZoom:Math.max(h,1)})}else{mui(j).zoom()}};b.loadImage=function(j,k){var i=function(){k&&k.call(this)};var h=new Image();h.onload=i;h.onerror=i;h.src=j.getAttribute("data-preview-lazyload")};b.getRangeByIndex=function(h,i){return{from:0,to:i-1}};b.open=function(h,i){if(typeof h!=="number"){h=0}i=i||c;this.addImages(i);this.openByGroup(h,i)};b.close=function(o,t){this.element.classList.add(mui.className("transitioning"));var r=this.scroller.querySelector(mui.classSelector(".slider-item:nth-child("+(this.lastIndex+1)+")"));var h=r.querySelector("img");if(h){h.classList.add(mui.className("transitioning"));var l=this.currentGroup[this.lastIndex];var p=l.sLeft-window.pageXOffset;var s=l.sTop-window.pageYOffset;if(s>window.innerHeight||p>window.innerWidth||s<0||p<0){h.addEventListener("webkitTransitionEnd",this._closeTransitionEnd.bind(this));h.style.opacity=0;h.style.webkitTransform="scale("+l.sScale+")"}else{var j=(window.innerWidth-l.sWidth)/2;var q=(window.innerHeight-l.sHeight)/2;h.addEventListener("webkitTransitionEnd",this._closeTransitionEnd.bind(this));h.style.webkitTransform="translate3d("+(p-j)+"px,"+(s-q)+"px,0) scale("+l.sScale+")"}}var k=this.element.querySelectorAll(mui.classSelector(".zoom-wrapper"));for(var m=0,n=k.length;m<n;m++){mui(k[m]).zoom().destory()}this.closeCallback&&this.closeCallback()};b.isShown=function(){return this.element.classList.contains(mui.className("preview-in"))};var f=null;mui.previewImage=function(h){if(!f){f=new d(h)}return f};mui.getPreviewImage=function(){return f}})();