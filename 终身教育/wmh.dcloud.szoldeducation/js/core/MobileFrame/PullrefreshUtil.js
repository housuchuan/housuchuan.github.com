define(function(require,w,a){var v=require("core/MobileFrame/CommonUtil");var o=require("core/MobileFrame/HtmlUtil");var c=("ontouchstart" in document);var d=c?"tap":"click";var j=null;var m={IsDebug:false,netRequestType:"mui",pullUpLoadType:"mui",pullUpRefreshTipRefresh:"正在加载...",pullUpRefreshTipNomoreData:"没有更多数据了",pullDownRefreshTipDown:"下拉可以刷新",pullDownRefreshTipOver:"释放立即刷新",pullDownRefreshTipRefresh:"正在刷新",refreshCallback:null,mDefaultInitPageNum:0,mGetLitemplate:null,mGetUrl:null,mGetRequestDataFunc:null,mChangeResponseDataFunc:null,mChangeToltalCountFunc:null,mGetDataOffLineFunc:null,mGetInitSessionDataCallback:null,mRequestSuccessCallbackFunc:null,mErrorRequestCallback:null,mOnItemClickCallbackFunc:null,mTargetListItemClickStr:"li",mListdataId:"listdata",mPullrefreshId:"pullrefresh",mRefreshEventName:"refreshListPage",mIsRequestFirst:true,IsRendLitemplateAuto:true,mDelyTime:300,mRequestTimeOut:15000,ajaxSetting:{accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:"",},loadMoreBtnStr:'<button id="PullDown_loadMoreBtn" class="noborder " style="font-size: 17px;display: block;width: 100%;margin-bottom: 10px;padding: 15px 0;  background-color: #fff;  color: #333;border: 1px solid #ccc;">点击加载更多</button>',loadingAnimationStr:null,noMoreDataTipStr:null};m.loadingAnimationStr=m.loadingAnimationStr||'<div id="PullDown_loadingAnimation"  style="padding: 5px 0 5px 9px; text-align: center;">'+m.pullUpRefreshTipRefresh+"</div>";m.noMoreDataTipStr=m.noMoreDataTipStr||'<div id="PullDown_noMoreData" style="z-index: 2;padding: 5px 0 5px 9px; text-align: center;">'+m.pullUpRefreshTipNomoreData+"</div>";w.initPullDownRefresh=function(x){if(j==null){j=new p(x);j.init()}return j};function p(x){m=v.extend(true,{},m,x);for(var y in m){this[y]=m[y]}}p.prototype.init=function(){j.pullRefreshContainer=document.getElementById(j.mPullrefreshId);j.respnoseEl=document.getElementById(j.mListdataId);var x;if(j.pullUpLoadType=="mui"){x={pullRefresh:{container:j.pullRefreshContainer,down:{contentdown:j.pullDownRefreshTipDown,contentover:j.pullDownRefreshTipOver,contentrefresh:j.pullDownRefreshTipRefresh,callback:l},up:{contentrefresh:j.pullUpRefreshTipRefresh,contentnomore:j.pullUpRefreshTipNomoreData,callback:q}}}}else{x={pullRefresh:{container:j.pullRefreshContainer,down:{contentdown:j.pullDownRefreshTipDown,contentover:j.pullDownRefreshTipOver,contentrefresh:j.pullDownRefreshTipRefresh,callback:l}}}}mui.init(x);if(window.plus){u()}else{if(window.mui&&mui.os.plus){mui.plusReady(function(){u()})}else{u()}}};function u(){var x=0;if(typeof j.mDefaultInitPageNum==="function"){x=j.mDefaultInitPageNum()}else{x=j.mDefaultInitPageNum}j.CurrPage=x;j.totalCount=0;j.IsLoadingMore=false;j.IsNoMoreData=false;if(j.mGetInitSessionDataCallback&&typeof(j.mGetInitSessionDataCallback)=="function"){t(j.mGetInitSessionDataCallback(),true)}if(j.mIsRequestFirst==true){setTimeout(function(){j.refreshFunc()},300)}n()}function i(){if(j.IsRendLitemplateAuto==true){if(j.respnoseEl!=null){j.respnoseEl.innerHTML=""}}}function n(){window.removeEventListener(j.mRefreshEventName,j.refreshFunc);window.addEventListener(j.mRefreshEventName,j.refreshFunc);g()}function l(){i();j.IsPullDownFlag=true;var x=0;if(typeof j.mDefaultInitPageNum==="function"){x=j.mDefaultInitPageNum()}else{x=j.mDefaultInitPageNum}j.CurrPage=x;j.refreshCallback&&j.refreshCallback(true);setTimeout(function(){s()},j.mDelyTime)}function q(){if(j.IsLoadingMore==false){j.IsLoadingMore=true;j.CurrPage++;j.IsPullDownFlag=false;setTimeout(function(){s()},j.mDelyTime)}}function b(z,x,y){j.CurrPage--;if(typeof j.mDefaultInitPageNum==="function"){defaultIndex=j.mDefaultInitPageNum()}else{defaultIndex=j.mDefaultInitPageNum}j.CurrPage=j.CurrPage>=defaultIndex?j.CurrPage:defaultIndex;k(false);if(j.mErrorRequestCallback!=null&&typeof(j.mErrorRequestCallback)=="function"){j.mErrorRequestCallback()}else{if(j.IsDebug==true){console.log("error***列表数据请求错误,状态:"+x+",错误信息:"+JSON.stringify(z))}}}function e(x,z){if(j.mGetDataOffLineFunc!=null&&typeof(j.mGetDataOffLineFunc)=="function"){var y=j.mGetDataOffLineFunc(x,z);t(y)}else{if(j.IsDebug==true){console.log("warning***没有网络准备获取离线数据,但是离线数据的回调没有传入")}if(window.mui){mui.toast("没有网络!")}}k(false)}function s(){if(j.mGetUrl==null){if(j.IsDebug==true){console.log("error***url无效,无法访问")}k(false);return}var y={};if(j.mGetRequestDataFunc==null||typeof(j.mGetRequestDataFunc)!="function"){console.log("warning***请注意getData不存在,默认数据为空")}else{y=j.mGetRequestDataFunc(j.CurrPage)}var x="";if(typeof(j.mGetUrl)=="function"){x=j.mGetUrl()}else{if(typeof(j.mGetUrl)=="string"){x=j.mGetUrl}}if(v.IsNetWorkCanUse()==true){if(j.netRequestType=="mui"){mui.ajax(x,{data:y,dataType:"json",timeout:j.mRequestTimeOut,type:"POST",accepts:j.ajaxSetting.accepts,contentType:j.ajaxSetting.contentType,headers:j.ajaxSetting.headers,success:t,error:b})}else{}}else{e(x,y)}}p.prototype.refreshFunc=function(){i();if(j.pullUpLoadType=="mui"){if(j.IsLoadingMore==false){if(typeof j.mDefaultInitPageNum==="function"){defaultIndex=j.mDefaultInitPageNum()}else{defaultIndex=j.mDefaultInitPageNum}j.CurrPage=defaultIndex-1;if(j.IsNoMoreData==true){mui(j.pullRefreshContainer).pullRefresh().refresh(true)}mui(j.pullRefreshContainer).pullRefresh().pullupLoading();if(!(window.plus&&plus.os.name==="Android")){mui(j.pullRefreshContainer).pullRefresh().scrollTo(0,0,100)}}}else{l();k(true)}};p.prototype.refreshFuncWithNoLoading=function(){i();l();k(true)};function h(x){var z=null;if(x!=null&&x.totalCount&&x.data&&Array.isArray(x.data)){z=x.data;j.totalCount=x.totalCount||0}else{if(x!=null&&x.EpointDataBody!=null&&x.EpointDataBody.DATA!=null&&x.EpointDataBody.DATA.UserArea!=null){if(Array.isArray(x.EpointDataBody.DATA.UserArea)){if(x.EpointDataBody.DATA.PageInfo!=null&&x.EpointDataBody.DATA.PageInfo.TotalNumCount!=null){j.totalCount=x.EpointDataBody.DATA.PageInfo.TotalNumCount}else{if(x.EpointDataBody.DATA.UserArea[0]&&x.EpointDataBody.DATA.UserArea[0].totalcount){j.totalCount=x.EpointDataBody.DATA.UserArea[0].totalcount}else{j.totalCount=0}}z=[];for(var y=0;y<x.EpointDataBody.DATA.UserArea.length;y++){z[y]=x.EpointDataBody.DATA.UserArea[y]}}else{if(x.EpointDataBody.DATA.UserArea.PageInfo!=null&&x.EpointDataBody.DATA.UserArea.PageInfo.TotalNumCount!=null){j.totalCount=x.EpointDataBody.DATA.UserArea.PageInfo.TotalNumCount}else{j.totalCount=0}if(x.EpointDataBody.DATA.UserArea.InfoList!=null&&x.EpointDataBody.DATA.UserArea.InfoList.Info!=null){z=[];if(Array.isArray(x.EpointDataBody.DATA.UserArea.InfoList.Info)){for(var y=0;y<x.EpointDataBody.DATA.UserArea.InfoList.Info.length;y++){z[y]=x.EpointDataBody.DATA.UserArea.InfoList.Info[y]}}else{z[0]=x.EpointDataBody.DATA.UserArea.InfoList.Info}}}}else{if(x&&Array.isArray(x)){j.totalCount=0;z=x}else{j.totalCount=0;z=x}}}return z}function t(A,y){if(!A){if(j.IsDebug==true){console.log("warning***返回的数据为空,请注意！");k(false)}return}if(j.mChangeResponseDataFunc&&typeof(j.mChangeResponseDataFunc)=="function"){A=j.mChangeResponseDataFunc(A)}else{A=h(A)}if(j.mChangeToltalCountFunc&&typeof(j.mChangeToltalCountFunc)=="function"){j.totalCount=j.mChangeToltalCountFunc(A)}else{if(j.mChangeToltalCountFunc!=null&&typeof(j.mChangeToltalCountFunc)=="number"&&!isNaN(parseInt(j.mChangeToltalCountFunc))){j.totalCount=j.mChangeToltalCountFunc}}if(j.IsRendLitemplateAuto==true){if(v.IsInclude("mustache.min.js")){if(A&&Array.isArray(A)&&A.length>0){var D="";for(var B=0;B<A.length;B++){var C=A[B];var x="";if(j.mGetLitemplate){if(typeof(j.mGetLitemplate)=="string"){x=j.mGetLitemplate}else{if(typeof(j.mGetLitemplate)=="function"){x=j.mGetLitemplate(C)}}}var z=Mustache.render(x,C);D+=z}if(D!=""){o.appendHtmlChildCustom(j.respnoseEl,D)}}}else{if(j.IsDebug==true){console.log("error***没有包含mustache.min.js,无法进行模板渲染")}}}if(j.mRequestSuccessCallbackFunc&&typeof(j.mRequestSuccessCallbackFunc)=="function"){if(typeof j.mDefaultInitPageNum==="function"){defaultIndex=j.mDefaultInitPageNum()}else{defaultIndex=j.mDefaultInitPageNum}j.mRequestSuccessCallbackFunc(A,j.IsPullDownFlag||(j.CurrPage==defaultIndex))}if(y==true){}else{k(false)}}function r(x){k(true);q()}function g(){mui("#"+j.mListdataId).on(d,"#PullDown_loadMoreBtn",r);if(j.mOnItemClickCallbackFunc&&typeof(j.mOnItemClickCallbackFunc)=="function"){mui("#"+j.mListdataId).on(d,j.mTargetListItemClickStr,j.mOnItemClickCallbackFunc)}}function k(B){if(j.IsPullDownFlag==true&&B==false){mui(j.pullRefreshContainer).pullRefresh().endPulldownToRefresh()}if(j.pullUpLoadType=="clickMore"){var A=document.getElementById("PullDown_loadMoreBtn");if(A){A.parentNode.removeChild(A)}var z=document.getElementById("PullDown_noMoreData");if(z){z.parentNode.removeChild(z)}var x=document.getElementById("PullDown_loadingAnimation");if(x){x.parentNode.removeChild(x)}if(B==true){o.appendHtmlChildCustom(j.respnoseEl,j.loadingAnimationStr)}else{var y=o.getChildElemLength(j.respnoseEl);if(y>=j.totalCount){if(j.pullUpRefreshTipNomoreData!=""){o.appendHtmlChildCustom(j.respnoseEl,j.noMoreDataTipStr)}}else{o.appendHtmlChildCustom(j.respnoseEl,j.loadMoreBtnStr)}}}else{if(j.pullUpLoadType=="mui"){if(B==true){}else{if(j.IsPullDownFlag==false||(j.IsNoMoreData==true&&j.IsPullDownFlag==true)){var y=o.getChildElemLength(j.respnoseEl);if(y>=j.totalCount){mui(j.pullRefreshContainer).pullRefresh().endPullupToRefresh(true);j.IsNoMoreData=true}else{if(j.IsNoMoreData==true){mui(j.pullRefreshContainer).pullRefresh().refresh(true)}j.IsNoMoreData=false;mui(j.pullRefreshContainer).pullRefresh().endPullupToRefresh(false)}}}}}j.IsLoadingMore=false}});