define(function(require,c,f){var d=require("core/MobileFrame/CommonUtil");var b={method:"POST",timeout:15,retry:2,data:{},files:null,successCallback:d.noop,errorCallback:d.noop,beforeUploadCallback:d.noop,uploadingCallback:d.noop,concurrentCount:3,maxTimeSingleTaskSpend:1000*10,ListenerProgressStep:5};var h={Queue:[],CurrentTaskCount:0};var a={};c.setOptions=function(i){if(!i){return}for(var j in b){if(i[j]!==undefined){b[j]=i[j]}}};c.upLoadFiles=function(s){var m=s||{};for(var q in b){if(m[q]===undefined||m[q]===null){m[q]=b[q]}}if(!m.url){console.log("上传Url为空,无法上传");return}m.beforeUploadCallback&&m.beforeUploadCallback();var k=plus.uploader.createUpload(m.url,m,function(v,i){if(i==200){if(m.successCallback&&typeof(m.successCallback)=="function"){var u=null;try{u=JSON.parse(k.responseText)}catch(w){}m.successCallback(u)}else{}}else{if(m.errorCallback&&typeof(m.errorCallback)=="function"){m.errorCallback(i)}else{}}h.CurrentTaskCount--;a[k.url]=null;g()});if(typeof(m.data)=="string"){try{m.data=JSON.parse(m.data)}catch(p){}}for(var r in m.data){k.addData(r,m.data[r])}if(m.files){for(var n=0;n<m.files.length;n++){var o=m.files[n];console.log("添加文件:"+JSON.stringify(o));k.addFile(o.path,{key:o.name})}}k.taskId=m.id||m.url;var l=0;var j=0;k.addEventListener("statechanged",function(t,i){switch(t.state){case 1:m.uploadingCallback&&m.uploadingCallback(0,"开始下载...");break;case 2:m.uploadingCallback&&m.uploadingCallback(0,"已连接到服务器");break;case 3:if(t.totalSize!=0){var u=t.uploadedSize/t.totalSize*100;u=Math.round(u);if(u-l>=m.ListenerProgressStep){l=u;m.uploadingCallback&&m.uploadingCallback(parseInt(u),"下载中")}}break;case 4:m.uploadingCallback&&m.uploadingCallback(100,"下载完成100%");break}});h.Queue.push({task:k,callbacks:m});g();return k};c.abortAllTask=function(){for(var j in a){a[j].taskObj&&a[j].taskObj.abort&&a[j].taskObj.abort();a[j].callbacks&&a[j].callbacks.errorCallback&&a[j].callbacks.errorCallback("上传任务被外部强行终结,url:"+j);a[j]=null}for(var k=0;k<h.Queue.length;k++){if(h.Queue[k].task){h.Queue[k].callbacks&&h.Queue[k].callbacks.errorCallback&&h.Queue[k].callbacks.errorCallback("上传队列中的任务被外部强行终结,url:"+h.Queue[k].task.url)}}h.Queue=[];h.CurrentTaskCount=0};c.abortTaskById=function(l){for(var j in a){if(a[j]&&a[j].taskObj&&a[j].taskObj.taskId==l){a[j].taskObj.abort&&a[j].taskObj.abort();h.CurrentTaskCount--;a[j].callbacks&&a[j].callbacks.errorCallback&&a[j].callbacks.errorCallback("上传任务被外部强行终结,id:"+l);a[j]=null}}for(var k=0;k<h.Queue.length;k++){if(h.Queue[k].task&&h.Queue[k].task.taskId==l){h.Queue[k].callbacks&&h.Queue[k].callbacks.errorCallback&&h.Queue[k].callbacks.errorCallback("上传队列中的任务被外部强行终结,id:"+l);h.Queue.splice(k,1)}}};function g(){for(var j in a){if(a[j]&&a[j].timeBegin&&(new Date()).valueOf()-a[j].timeBegin>b.maxTimeSingleTaskSpend){a[j].taskObj&&a[j].taskObj.abort&&a[j].taskObj.abort();a[j].callbacks&&a[j].callbacks.errorCallback&&a[j].callbacks.errorCallback("上传错误:上传超时,被强行终结!");h.CurrentTaskCount--;a[j]=null}}if(h.CurrentTaskCount<b.concurrentCount){if(h.Queue.length>0){var k=h.Queue.shift();var i=k.task;i.start();h.CurrentTaskCount++;a[i.url]={taskObj:i,timeBegin:(new Date()).valueOf(),callbacks:k.callbacks}}else{}}else{}}});