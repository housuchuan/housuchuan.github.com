define(function(require,x,d){var w=require("core/MobileFrame/CommonUtil");var a=require("core/MobileFrame/FileUtil");var t={downloadStoragePath:"_downloads/downloadFiles/",fileCacheTimeStamp:1000*60*60*24*1,concurrentDownloadCount:3,timeout:3,retryInterval:3,maxTimeSingleDownloadTaskSpend:1000*10,getRelativePathFromLoadUrlCallback:null,ListenerProgressStep:5};var u={};for(var y in t){u[y]=t[y]}var v="downloadFile_SessionKey_util_caches_";var p="downloadFile_SessionKey_util_Manager";var n={};var r={Queue:[],CurrentTaskCount:0};var k={};function h(A){var z=plus.storage.getItem(p);if(z==null){z=[]}else{try{z=JSON.parse(z)}catch(B){}}if(z.indexOf(A)==-1){z.push(A)}plus.storage.setItem(p,JSON.stringify(z))}function s(C){var B=plus.storage.getItem(p);if(B==null){return}try{B=JSON.parse(B)}catch(D){}var z=-1;for(var A=0;A<B.length||0;A++){if(B[A]==C){z=A}}if(z!=-1){B.splice(z,1);plus.storage.setItem(p,JSON.stringify(B))}}function c(z,A){if(z==null){return}h(z);z=v+w.getRelativePathKey(z);A=(A!=null)?A:"";A=(typeof(A)=="string")?A:JSON.stringify(A);plus.storage.setItem(z,A)}function q(z){if(z==null){return null}z=v+w.getRelativePathKey(z);var A=plus.storage.getItem(z);try{if(A!=null){A=JSON.parse(A)}}catch(B){}return A}function f(A){if(A==null){return null}s(A);A=v+w.getRelativePathKey(A);var z=plus.storage.removeItem(A)}function b(){w.plusReady(function(){var A=plus.storage.getItem(p);if(A==null){return}try{A=JSON.parse(A)}catch(B){}if(Array.isArray(A)){for(var z=0;z<A.length;z++){f(A[z])}}})}x.setOptions=function(z){if(!z){return}for(var A in t){if(z[A]!==undefined){t[A]=z[A]}}};x.RestoreOptions=function(){if(u){t=u}};x.clearAllLocalFileCache=function(z,A){w.plusReady(function(){var B=plus.io.convertLocalFileSystemURL(t.downloadStoragePath);B="file://"+B;b();plus.io.resolveLocalFileSystemURL(B,function(C){C.removeRecursively(function(){if(z&&typeof(z)=="function"){z("清除本地缓存成功!路径:"+t.downloadStoragePath)}},function(){if(A&&typeof(A)=="function"){A("清除本地缓存失败!路径:"+t.downloadStoragePath)}})},function(C){if(A&&typeof(A)=="function"){A("打开本地缓存目录失败!"+t.downloadStoragePath)}})})};x.clearNetUrlFileCache=function(B,z,A){w.plusReady(function(){f(B);a.delFile(g(B),z,A)})};x.abortTaskByUrl=function(A){k[A]&&k[A].taskObj&&k[A].taskObj.abort&&k[A].taskObj.abort();r.CurrentTaskCount--;k[A]=null;j(A,false);for(var z=0;z<r.Queue.length;z++){if(r.Queue[z].task&&r.Queue[z].task.url==A){r.Queue[z].callbacks&&r.Queue[z].callbacks.errorDownload&&r.Queue[z].callbacks.errorDownload("下载队列中的任务被外部强行终结,url:"+A);r.Queue.splice(z,1)}}};x.abortAllTask=function(){for(var z in k){k[z].taskObj&&k[z].taskObj.abort&&k[z].taskObj.abort();k[z]=null;j(z,false)}for(var A=0;A<r.Queue.length;A++){if(r.Queue[A].task){r.Queue[A].callbacks&&r.Queue[A].callbacks.errorDownload&&r.Queue[A].callbacks.errorDownload("下载队列中的任务被外部强行终结,url:"+loadUrl)}}r.Queue=[];r.CurrentTaskCount=0};function g(C){var z=null;if(t.getRelativePathFromLoadUrlCallback&&typeof(t.getRelativePathFromLoadUrlCallback)=="function"){z=t.getRelativePathFromLoadUrlCallback(C)}else{var D=C.substring(C.lastIndexOf(".")+1,C.length);D=D||"file";var A=/[&\|\\\*^%$#@\-:.?\/=!]/g;var E=C.replace(A,"");E=E.trim();if(E.length>100){E=E.substr(E.length-100,E.length)}var B=E+"."+D;z=t.downloadStoragePath+B}return z}function i(z){var A=q(z);if(A!=null){if(A.time){A.time=parseInt(A.time,10);if((new Date()).valueOf()-A.time>t.fileCacheTimeStamp){return true}else{return false}}}return false}x.downloadFileWidthLocalCache=function(A,z,B){if(A==null){return}B=typeof(B)=="boolean"?B:true;z=z||{};w.plusReady(function(){var D=g(A);var E=/[\u4E00-\u9FA5]/g;var C=A.replace(E,"chineseRemoveAfter");if(C.indexOf("chineseRemoveAfter")!=-1){A=encodeURI(A)}if(i(A)==false&&B==true){plus.io.resolveLocalFileSystemURL(D,function(F){z.successDownload&&z.successDownload(D,true)},function(F){e(A,z)})}else{plus.io.resolveLocalFileSystemURL(D,function(F){a.delFile(D,function(){e(A,z)},function(){console.error("下载文件错误:删除本地已有文件时失败!")})},function(F){e(A,z)})}})};function e(B,z){z=z||{};if(w.IsNetWorkCanUse()==true){var A=g(B);var C=w.getRelativePathKey(A);if(n&&n[C]&&Array.isArray(n[C])){n[C].push(z);z.beforeDownload&&z.beforeDownload();return}else{n[C]=[];n[C].push(z)}o(B,z)}else{z.errorDownload&&z.errorDownload("下载失败:没有网络!,url:"+B)}}function o(E,z){var A=g(E);if(A==null){return}z=z||{};var C={filename:A,timeout:t.timeout,retryInterval:t.retryInterval};var D=E;E=w.changImgUrlTypeWithRandomKey(E);z.beforeDownload&&z.beforeDownload();var G=plus.downloader.createDownload(E,C,function(I,H){if(H==200){j(D,true)}else{if(A!=null){a.delFile(A)}j(D,false)}r.CurrentTaskCount--;k[G.url]=null;m()});var F=0;var B=0;G.addEventListener("statechanged",function(I,H){switch(I.state){case 1:z.downloading&&z.downloading(0,"开始下载...");break;case 2:z.downloading&&z.downloading(0,"已连接到服务器");break;case 3:if(I.totalSize!=0){var J=I.downloadedSize/I.totalSize*100;J=Math.round(J);if(J-F>=t.ListenerProgressStep){F=J;z.downloading&&z.downloading(parseInt(J),"下载中")}}break;case 4:z.downloading&&z.downloading(100,"下载完成100%");break}});r.Queue.push({task:G,callbacks:z});m()}function j(D,z){var B=g(D);var E=w.getRelativePathKey(B);if(n&&n[E]){var A=n[E];if(Array.isArray(A)){for(var C=0;C<A.length;C++){if(z==true){A[C].successDownload&&A[C].successDownload(B,z)}else{A[C].errorDownload&&A[C].errorDownload("下载失败",z)}}}else{if(z==true){A.successDownload&&A.successDownload(B,z)}else{A.errorDownload&&A.errorDownload("下载失败",z)}}n[E]=null}}function m(){for(var A in k){if(k[A]&&k[A].timeBegin&&(new Date()).valueOf()-k[A].timeBegin>t.maxTimeSingleDownloadTaskSpend){k[A].taskObj&&k[A].taskObj.abort&&k[A].taskObj.abort();r.CurrentTaskCount--;k[A]=null;j(A,false)}}if(r.CurrentTaskCount<t.concurrentDownloadCount){if(r.Queue.length>0){var B=r.Queue.shift();var z=B.task;z.start();r.CurrentTaskCount++;k[z.url]={taskObj:z,timeBegin:(new Date()).valueOf()}}else{}}else{}}});