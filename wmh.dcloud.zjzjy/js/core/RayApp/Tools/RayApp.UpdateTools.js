define(function(require,exports,module){"use strict";function e(e,o){plus.io.resolveLocalFileSystemURL(U.localUpdatePackageFileDir,function(o){e&&"function"==typeof e&&e(o)},function(t){plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS,function(t){t.root.getDirectory(U.localUpdateFileDir,{create:!0},function(o){e&&"function"==typeof e&&e(o)},function(e){o&&o("打开update目录失败..."+e.message)})},function(e){o&&o("打开download目录失败..."+e.message)})})}function o(n,r,i,a){null==D&&e(function(e){D=e,o(n,r,i)}),D.getFile(n,{create:!0},function(e){t(e,r,function(){i&&"function"==typeof i&&i()},a)},function(e){a&&a("写入数据，打开保存文件失败："+e.message)})}function t(e,o,t,n){return e&&0!=e.isFile?void e.createWriter(function(e){e.onerror=function(){n&&n("写入数据，保存文件失败！")},e.write(o),t&&"function"==typeof t&&t()},function(e){n&&n("创建写文件对象失败："+e.message)}):void(n&&n("目标文件对象有误!"))}function n(e,o,t){return e&&0!=e.isFile?void e.file(function(e){var n=new plus.io.FileReader;n.onloadend=function(e){var n=null;try{n=JSON.parse(e.target.result)}catch(e){t&&t("读取本地升级文件，数据格式错误！"+e)}o&&"function"==typeof o&&o(n)},n.readAsText(e)},function(o){t&&t("读取本地升级文件，获取文件对象失败："+o.message),e.remove()}):void(t&&t("目标文件对象有误"))}function r(e){var o=U.localUpdatePackageFileDir+U.localUpdateFile;1==U.isDebug&&console.log("更新文件本地路径:"+o+",服务器地址:"+U.updateUrl),p.delFile(o);var t=U;t.getRelativePathFromLoadUrlCallback=function(){return o},d.setOptions(t);var n=U.updateUrl||U.UpdateUrl;d.downloadFileWidthLocalCache(n,{beforeDownload:function(){e&&e.beforeDownloadJson&&e.beforeDownloadJson()},successDownload:function(o){1==U.isDebug&&console.log("成功下载更新文件:"+o),i(e)},errorDownload:function(o){e&&e.errorUpdate&&e.errorUpdate("请求更新信息文件时:"+o)}},!1)}function i(e){return null==D?void(e&&e.errorUpdate&&e.errorUpdate("下载后本地更新文件不存在,请检查写入权限")):void D.getFile(U.localUpdateFile,{create:!1},function(o){n(o,function(o){null!=o?a(o,e):e&&e.errorUpdate&&e.errorUpdate("读取更新文件时出错,造成了空值!")},function(o){e&&e.errorUpdate&&e.errorUpdate(o)})},function(o){e&&e.errorUpdate&&e.errorUpdate("更新文件下载错误..."+o.message)})}function a(e,o){1==U.isDebug&&(console.log("检查应用包版本,当前版本:"+exports.getCurrentAppVersion()+",新的版本:"+e[plus.os.name].AppVersion),console.log("检查资源包版本,当前资源包版本:"+m+",新的资源包:"+e[plus.os.name].ResourcePackage.resourceVersion)),e&&e[plus.os.name]&&e[plus.os.name].ResourcePackage?1==c.compareVersion(exports.getCurrentAppVersion(),e[plus.os.name].AppVersion)?s(e,!0,o):1==c.compareVersion(m,e[plus.os.name].ResourcePackage.resourceVersion)?s(e,!1,o):o&&o.errorUpdate&&o.errorUpdate("当前已经是最新版本",0):o&&o.errorUpdate&&o.errorUpdate("更新文件格式有误...")}function s(e,o,t){var n=U.defaultshowInfoTitle,r=U.defaultshowInfoDetail,i=U.defaultconfirmBtn,a=U.defaultcancelBtn;1==o?(n=e[plus.os.name].InfoTitle?e[plus.os.name].InfoTitle:n,r=e[plus.os.name].InfoDetail?e[plus.os.name].InfoDetail:r):(n=e[plus.os.name].ResourcePackage.InfoTitle?e[plus.os.name].ResourcePackage.InfoTitle:n,r=e[plus.os.name].ResourcePackage.InfoDetail?e[plus.os.name].ResourcePackage.InfoDetail:r),plus.ui.confirm(r,function(n){0==n.index?(w=!1,l(e,o,t)):(t&&t.errorUpdate&&t.errorUpdate("取消更新,下次再升级",2),"1"==e.IsMust&&("Android"==plus.os.name?plus.nativeUI.alert("注意!升级后才能正常使用!",function(){plus.runtime.quit()}):0==o&&plus.nativeUI.alert("注意!升级后才能正常使用!",function(){plus.runtime.quit()})))},n,[i,a])}function l(e,o,t){var n="";if(1==o){if(n=e[plus.os.name].AppUrl,"iOS"==plus.os.name)return e[plus.os.name].AppUrl&&""!=e[plus.os.name].AppUrl?void plus.runtime.openURL(e[plus.os.name].AppUrl):void(t&&t.errorUpdate&&t.errorUpdate("新版本地址错误,请检查更新文件..."));if(!e[plus.os.name].AppUrl||""==e[plus.os.name].AppUrl)return void(t&&t.errorUpdate&&t.errorUpdate("新版本地址错误,请检查更新文件..."))}else{if(!e[plus.os.name].ResourcePackage.resourceUrl||""==e[plus.os.name].ResourcePackage.resourceUrl)return void(t&&t.errorUpdate&&t.errorUpdate("新的资源包地址错误,请检查更新文件..."));n=e[plus.os.name].ResourcePackage.resourceUrl}U.getRelativePathFromLoadUrlCallback=null,d.restoreOptions(),d.setOptions(U),F=n,d.downloadFileWidthLocalCache(F,{beforeDownload:function(){t&&t.beforeDownloadFile&&t.beforeDownloadFile()},successDownload:function(n){g=m,v=exports.getCurrentAppVersion(),0==w&&setTimeout(u(n,e,o,t),3e3)},errorDownload:function(e){t&&t.errorUpdate&&t.errorUpdate("下载更新包时:"+e)},downloading:function(e,o){t&&t.downloadingFile&&t.downloadingFile(e,o)}},!1)}function u(e,t,n,r){return 1==w?void(r&&r.errorUpdate&&r.errorUpdate("安装更新包失败！已经被手动取消!")):(r&&r.beforeInstall&&r.beforeInstall("在线升级，安装更新文件..."),void plus.runtime.install(e,{force:!0},function(e){var i="default.json";i=1==n?"updateHistory_typeApp_"+v+"_"+t[plus.os.name].AppVersion+".json":"updateHistory_typeResource_"+exports.getCurrentAppid()+"_"+g+"_"+t[plus.os.name].ResourcePackage.resourceVersion+".json",0==w&&(o(i,JSON.stringify(t),function(){r&&r.successWriteUpdateHistory&&r.successWriteUpdateHistory("写入更新历史成功")},function(e){r&&r.errorWriteUpdateHistory&&r.errorWriteUpdateHistory(e)}),d.restoreOptions(),r&&r.successUpdate&&r.successUpdate("应用资源更新完成,重启后生效!"))},function(o){p.delFile(e);var t=o?o.code:"未知错误",n=o?o.message:"未知错误";r&&r.errorUpdate&&r.errorUpdate("安装更新文件失败["+t+"]:"+n)}))}var c=require("CommonTools_Core"),p=require("FileTools_Core"),d=require("DownLoadTools_Core"),f=require("NotificationTools_Core"),U={isDebug:!0,timeout:10,retry:1,retryInterval:1,updateUrl:"",UpdateUrl:"",localUpdateFileDir:"update",localUpdateFile:"update.json",localUpdatePackageFileDir:"_downloads/update/",defaultshowInfoTitle:"更新提示",defaultshowInfoDetail:"有新版本拉！",defaultconfirmBtn:"立即更新",defaultcancelBtn:"下次再说"},m="",g="",v="",D=null,w=!1,F=null;exports.setOptions=function(e){if(e)for(var o in U)void 0!==e[o]&&(U[o]=e[o])},exports.getCurrentAppid=function(){return plus.runtime.appid},exports.getCurrentAppVersion=function(){return plus.runtime.version},exports.getCurrentResourceVersion=function(e){c.plusReady(function(){plus.runtime.getProperty(exports.getCurrentAppid(),function(o){m=o.version,e&&"function"==typeof e&&e(o)})})},exports.abortUpdate=function(){F&&d.abortTaskByUrl(F);var e=U.updateUrl||U.UpdateUrl;d.abortTaskByUrl(e)},exports.initUpdate=function(o){c.plusReady(function(){exports.getCurrentResourceVersion(),e(function(e){D=e,r(o)},function(e){o&&o.errorUpdate&&o.errorUpdate(e)})})},exports.initUpdateWithDefaultType=function(e){function o(){0==n&&(exports.abortUpdate(),r&&r.compProgressNotification("终止更新","已经终止更新","更新提示"),mui.toast("已经手动终止更新！"))}var t=null,n=!1,r=null,i={beforeDownloadJson:function(){1==e?(r=f.initNotificationControl(),r.setNotification("检查更新","正在检查更新信息","更新提示"),"iOS"==plus.os.name&&mui.toast("正在检查更新信息")):(t=plus.nativeUI.showWaiting("正在检查更新文件",{back:"close",padlock:!0}),t.onclose=function(){})},beforeDownloadFile:function(){1==e?(r&&r.setNotification("准备更新","准备开始下载更新文件","更新提示"),"iOS"==plus.os.name&&mui.toast("正在后台下载更新包...")):(t&&t.close(),t=plus.nativeUI.showWaiting("准备下载更新包",{back:"close",padlock:!0}),t.onclose=o)},downloadingFile:function(o,i){1==e?r&&r.setProgress(parseInt(o),"正在更新","正在后台下载更新文件","更新提示"):t&&t.setTitle(parseInt(o)+"%,"+i),o>=100&&(n=!0)},beforeInstall:function(o){1==e?(r&&r.compProgressNotification("安装更新","正在安装更新文件","更新提示"),"iOS"==plus.os.name&&mui.toast("正在安装更新包...")):t&&t.setTitle("正在安装更新包...")},successUpdate:function(e){n=!0,r&&r.setNotification("更新完毕","更新文件已经安装完毕","更新提示"),t&&t.close(),plus.nativeUI.confirm(e,function(e){0==e.index&&(r&&r.clearNotification(),plus.runtime.restart())},"更新成功",["立即重启","手动重启"])},errorUpdate:function(e,o,i){n=!0,t&&t.close(),0==o?mui.toast("已经是最新版本!"):1==o?mui.alert("请前往appstore下载:"+i,"ios更新","我知道了"):2==o||(mui.alert(e,"更新失败","我知道了"),r&&r.clearNotification())}};exports.initUpdate(i)}});