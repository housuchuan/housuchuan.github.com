define(function(require,exports,module){"use strict";function e(e){var o=this;e.element=document.getElementById(e.bizlogic.pullrefreshId),e.down&&(e.down.callback=function(){o.pullDownCallback()}),e.up&&(e.up.callback=function(){o.pullUpCallback()}),o.options=e,o.pullRefreshContainer=e.element,o.respnoseEl=document.getElementById(e.bizlogic.listdataId),o.totalCount=0,o.currPage=o.options.bizlogic.defaultInitPageNum,o.options.up&&o.options.up.auto&&o.currPage--,o.initAllEventListeners(),o.pullToRefreshInstance=t.initPullToRefresh(e)}var t,o=require("CommonTools_Core"),n=require("HtmlTools_Core"),l="ontouchstart"in document,i=l?"tap":"click",a={isDebug:!1,down:{height:75,contentdown:"下拉可以刷新",contentover:"释放立即刷新",contentrefresh:"正在刷新"},up:{auto:!1,offset:100,show:!0,contentdown:"上拉显示更多",contentrefresh:"正在加载...",contentnomore:"没有更多数据了"},bizlogic:{defaultInitPageNum:0,getLitemplate:null,getUrl:null,getRequestDataCallback:null,changeResponseDataCallback:null,changeToltalCountCallback:null,successRequestCallback:null,errorRequestCallback:null,refreshCallback:null,itemClickCallback:null,targetListItemClickStr:"li",listdataId:"listdata",pullrefreshId:"pullrefresh",refreshEventName:"refreshListPage",delyTime:300,ajaxSetting:{requestType:"POST",requestTimeOut:15e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null},isRendLitemplateAuto:!0},skin:"default"};e.prototype.pullDownCallback=function(){var e=this;e.loadingDown||(e.isPullDown=!0,e.loadingDown=!0,e.currPage=e.options.bizlogic.defaultInitPageNum,setTimeout(function(){e.ajaxRequest()},e.options.bizlogic.delyTime),e.options.bizlogic.refreshCallback&&e.options.bizlogic.refreshCallback(!0))},e.prototype.pullUpCallback=function(){var e=this;e.loadingUp||(e.isPullDown=!1,e.loadingUp=!0,e.currPage++,setTimeout(function(){e.ajaxRequest()},e.delyTime))},e.prototype.initAllEventListeners=function(){var e=this,t=function(t){e.refresh()};window.removeEventListener(e.options.bizlogic.refreshEventName,t),window.addEventListener(e.options.bizlogic.refreshEventName,t),e.setElemListeners()},e.prototype.setElemListeners=function(){var e=this;e.options.bizlogic.itemClickCallback&&mui("#"+e.options.bizlogic.listdataId).on(i,e.options.bizlogic.targetListItemClickStr,e.options.bizlogic.itemClickCallback)},e.prototype.refresh=function(){var e=this;e.options.up?e.loadingUp||(e.clearResponseEl(),e.currPage=e.options.bizlogic.defaultInitPageNum-1,e.pullToRefreshInstance.finished&&e.pullToRefreshInstance.refresh(!0),e.pullToRefreshInstance.pullupLoading()):(e.clearResponseEl(),e.pullDownCallback())},e.prototype.ajaxRequest=function(){var e=this;if(!e.options.bizlogic.getUrl)return e.options.isDebug&&console.error("error***url无效,无法访问"),void e.errorRequest(null,null,"请求url为空!");var t={};e.options.bizlogic.getRequestDataCallback?t=e.options.bizlogic.getRequestDataCallback(e.currPage):e.options.isDebug&&console.warn("warning***请注意getData不存在,默认数据为空");var o="";o="function"==typeof e.options.bizlogic.getUrl?e.options.bizlogic.getUrl():e.options.bizlogic.getUrl,mui.ajax(o,{data:t,dataType:"json",timeout:e.options.bizlogic.requestTimeOut,type:e.options.bizlogic.ajaxSetting.requestType,accepts:e.options.bizlogic.ajaxSetting.accepts,headers:e.options.bizlogic.ajaxSetting.headers,contentType:e.options.bizlogic.ajaxSetting.contentType,success:function(t){e.successRequest(t)},error:function(t,o){e.errorRequest(t,o,"请求失败!")}})},e.prototype.errorRequest=function(e,t,o){var n=this;n.refreshState(),n.currPage--,n.currPage=n.currPage>=n.defaultInitPageNum?n.currPage:n.defaultInitPageNum,n.options.bizlogic.errorRequestCallback&&n.options.bizlogic.errorRequestCallback(e,t,o)},e.prototype.successRequest=function(e,t){var o=this;if(!e)return o.options.isDebug&&console.log("warning***返回的数据为空,请注意！"),void o.refreshState();if(o.options.isDebug&&console.log("下拉刷新返回数据:"+JSON.stringify(e)),e=o.options.bizlogic.changeResponseDataCallback?o.options.bizlogic.changeResponseDataCallback(e):o.defaultChangeResponseData(e),o.options.bizlogic.changeToltalCountCallback&&"function"==typeof o.options.bizlogic.changeToltalCountCallback?o.totalCount=o.options.bizlogic.changeToltalCountCallback(e):o.options.bizlogic.changeToltalCountCallback&&"number"==typeof o.options.bizlogic.changeToltalCountCallback&&(o.totalCount=o.options.bizlogic.changeToltalCountCallback),o.options.bizlogic.isRendLitemplateAuto)if(o.isPullDown&&o.clearResponseEl(),window.Mustache){if(e&&Array.isArray(e)&&e.length>0){for(var l="",i=0;i<e.length;i++){var a=e[i],s="";o.options.bizlogic.getLitemplate&&("string"==typeof o.options.bizlogic.getLitemplate?s=o.options.bizlogic.getLitemplate:"function"==typeof o.options.bizlogic.getLitemplate&&(s=o.options.bizlogic.getLitemplate(a)));var r=Mustache.render(s,a);l+=r}""!=l&&n.appendHtmlChildCustom(o.respnoseEl,l)}}else 1==o.options.isDebug&&console.error("error***没有包含mustache.min.js,无法进行模板渲染");o.options.bizlogic.successRequestCallback&&"function"==typeof o.options.bizlogic.successRequestCallback&&o.options.bizlogic.successRequestCallback(e,o.isPullDown||o.currPage==o.options.bizlogic.defaultInitPageNum),t||o.refreshState()},e.prototype.defaultChangeResponseData=function(e){var t=this,n=null;if(e&&e.EpointDataBody&&e.EpointDataBody.DATA&&e.EpointDataBody.DATA.UserArea&&e.EpointDataBody.DATA.UserArea.InfoList){if(null!=e.EpointDataBody.DATA.UserArea.PageInfo&&null!=e.EpointDataBody.DATA.UserArea.PageInfo.TotalNumCount?t.totalCount=e.EpointDataBody.DATA.UserArea.PageInfo.TotalNumCount:t.totalCount=0,null!=e.EpointDataBody.DATA.UserArea.InfoList){n=[];var l=null;if(l=e.EpointDataBody.DATA.UserArea.InfoList.Info?e.EpointDataBody.DATA.UserArea.InfoList.Info:e.EpointDataBody.DATA.UserArea.InfoList,Array.isArray(l))for(var i=0;i<l.length;i++)n[i]=l[i];else n[0]=l}}else{var a=o.handleStandardResponse(e,1);t.totalCount=a.totalCount,n=a.data}return n},e.prototype.refreshState=function(){var e=this;e.isPullDown&&e.pullToRefreshInstance.endPullDownToRefresh(),e.pullToRefreshInstance.finished&&e.pullToRefreshInstance.refresh(!0);var t=n.getChildElemLength(e.respnoseEl);t>=e.totalCount?e.pullToRefreshInstance.endPullUpToRefresh(!0):e.pullToRefreshInstance.endPullUpToRefresh(!1),e.loadingDown=!1,e.loadingUp=!1},e.prototype.clearResponseEl=function(){var e=this;e.options.bizlogic.isRendLitemplateAuto&&e.respnoseEl&&(e.respnoseEl.innerHTML="")},exports.initPullDownRefresh=function(n,l){n=o.extend(!0,{},a,n);var i=function(o){t=o;var i=new e(n);l&&l(i)};"default"===n.skin?require.async("PullToRefresh_Base_Default_Core",i):"type0"===n.skin?require.async("PullToRefresh_Base_Type0_Core",i):(o.importFile("css/RayApp/RayApp.PullToRefresh.css"),"type1"===n.skin?require.async("PullToRefresh_Base_Type1_Core",i):"type1_material1"===n.skin?require.async("PullToRefresh_Base_Type1__Material1_Core",i):console.error("错误:传入的下拉刷新皮肤错误,超出范围!"))}});