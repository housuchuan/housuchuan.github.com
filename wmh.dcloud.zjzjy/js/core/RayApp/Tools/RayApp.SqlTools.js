define(function(require,exports,module){"use strict";function e(e,r){return e+"_"+r}function r(r,t,o){r.onerror=function(e){console.error("OPen IndexdedDB Error!错误信息:"+JSON.stringify(e.target)),o&&o("OPen IndexdedDB Error!错误信息:"+JSON.stringify(e.target)),t.dispose()},r.onsuccess=function(r){t.targetDB=r.target.result;var n=e(t.name,t.version);i[n]=t,console.log("创建DB成功,"+n),o&&o("创建DB成功,"+n)},r.onupgradeneeded=function(r){console.warn("DB version changed to "+t.version),o&&o("DB version changed to "+t.version),t.targetDB=r.target.result;var a=e(t.name,t.version);i[a]=t;var s=t.options.objectStores;if(s&&Array.isArray(s))for(var c=0,u=s.length;c<u;c++)n(s[c],t.targetDB)}}function n(e,r){if(e.name){var n,t=e.name;n=e.keyPath?r.createObjectStore(t,{keyPath:e.keyPath}):r.createObjectStore(t,{autoIncrement:!0});var o=e.indexsl;if(n&&o&&Array.isArray(o))for(var i=0,a=o.length;i<a;i++)s(o[i]);var s=function(e){e.name&&e.keyPath&&n.createIndex(e.name,e.keyPath,{unique:e.unique})}}}function t(e,n,t,o){var i=this;if(e=e||a,t=t||{},n=n||1,i.name=e,i.version=n,i.options=t,window.indexedDB){var s=window.indexedDB.open(e,n);r(s,i,o)}else o&&o("错误,浏览器不支持indexedDB")}function o(e,r,n,t,o,i,a){var s="readwrite";"get"===o&&(s="readonly");var c=e.transaction([r],s);c.oncomplete=function(e){console.log("事务成功完成")},c.onerror=function(e){a&&a("事务出错",e.target)};var u=function(){var e,s=c.objectStore(r),u="";if("get"===o)u="获取数据",e=s.get(n);else if("set"===o){if(u="存储数据",Array.isArray(t))for(var d=0,l=t.length;d<l;d++)e=s.put(t[d])}else"remove"===o?(u="移除数据:"+n,e=s["delete"](n)):"clear"===o&&(u="情况store:"+r,e=s.clear());e?(e.onsuccess=function(e){var r=e.target.result;i&&i(r,u+"成功")},e.onerror=function(e){a&&a(u+"失败!",e.target)}):a&&a("objectStoreRequest获取失败",{tips:"请检查是否操作超出get,set,remove,clear范围"})};u()}window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;var i={},a="MYINDEXDEDDB_DEFAULT";t.prototype.dispose=function(){var r=this;r.targetDB&&r.targetDB.close();var n=e(r.name,r.version);i[n]=null,r.targetDB=null,r.version=null,r.name=null,r=null},t.prototype.setItem=function(e,r,n,t){if(!e)return void console.error("写入失败,storeName不能为空!");if(!r)return void console.error("写入失败,写入数据不能为空!");var i=this,a=i.targetDB;o(a,e,null,r,"set",n,t)},t.prototype.getItem=function(e,r,n,t){if(!e)return void console.error("获取数据失败,storeName不能为空!");var i=this,a=i.targetDB;o(a,e,r,null,"get",n,t)},t.prototype.removeItem=function(e,r,n,t){e||console.error("移除item失败,storeName不能为空!");var i=this,a=i.targetDB;o(a,e,r,null,"remove",n,t)},t.prototype.clearStore=function(e,r,n){e||console.error("清空store失败,storeName不能为空!");var t=this,i=t.targetDB;o(i,e,null,null,"clear",r,n)},t.prototype.cursorStore=function(e,r,n){e||console.error("cursor遍历store失败,storeName不能为空!");var t=this,o=t.targetDB,i=o.transaction(e).objectStore(e),a=[];i.openCursor().onsuccess=function(n){var t=n.target.result;t?(a.push({key:t.key,value:t.value}),t["continue"]()):r&&r(a,"遍历"+e+"成功")},i.openCursor().onerror=function(r){n&&n("遍历"+e+"出错",r.target)}},exports.openDB=function(r,n,o,a){var s=e(r,n);return i[s]?(a&&a("从缓存中获取DB"),i[s]):new t(r,n,o,a)},exports.deleteDB=function(e,r){return e?(window.indexedDB.deleteDatabase(e),void(r&&r("删除"+e+"成功"))):void console.error("删除indexdedDB错误,名字为空,无法删除!")}});