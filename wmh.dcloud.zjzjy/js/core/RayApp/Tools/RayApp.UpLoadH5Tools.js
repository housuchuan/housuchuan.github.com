define(function(require,exports,module){"use strict";function e(e){var a=this;a.options=o.extend(!0,{},t,e),a.init()}var o=require("CommonTools_Core"),t={url:"",timeout:10,data:{},files:null,successCallback:o.noop,errorCallback:o.noop,beforeUploadCallback:o.noop,uploadingCallback:o.noop,ListenerProgressStep:5};e.prototype.init=function(){var e=this;e.previousLoadedBytes=0,e.previousTimeStamp=(new Date).valueOf(),e.speedStr=0;var o=new FormData;if("object"==typeof e.options.data)for(var t in e.options.data)o.append(t,e.options.data[t]);else o.append(e.options.data,"");var a=e.options.files;if(a)for(var r=0,n=a.length;r<n;r++)o.append(a[r].name,a[r].file);var s=new XMLHttpRequest,i=0;s.upload.addEventListener("progress",function(o){var t=(new Date).valueOf();if(t-e.previousTimeStamp>1e3){var a=o.loaded-e.previousLoadedBytes,r=1e3*a/(t-e.previousTimeStamp);e.previousLoadedBytes=o.loaded,e.previousTimeStamp=t,e.speedStr=r.toString()+"B/s",r>1048576?e.speedStr=Math.round(r/1048576).toString()+"MB/s":r>1024&&(e.speedStr=Math.round(r/1024).toString()+"KB/s")}var n=(o.loaded/o.total*100).toFixed(2);n-i>=e.options.ListenerProgressStep&&(i=n,e.options.uploadingCallback(n,"上传中",e.speedStr))},!1),s.addEventListener("load",function(o){var t=null;try{t=JSON.parse(o.target.responseText)}catch(o){}e.options.successCallback(t,o.target.responseText)},!1),s.addEventListener("error",function(o){e.options.errorCallback("上传失败",o.target.responseText)},!1),s.addEventListener("abort",function(o){e.options.errorCallback("上传中断",o.target.responseText)},!1),e.options.beforeUploadCallback(),s.open("POST",e.options.url,!0),s.send(o)},exports.upLoadFiles=function(o){var t=new e(o);return t}});