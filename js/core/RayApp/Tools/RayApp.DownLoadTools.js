define(function(require,exports,module){"use strict";function e(e){var o=plus.storage.getItem(h);if(null!=o){try{o=JSON.parse(o)}catch(a){}for(var n=-1,t=0;t<o.length;t++)o[t]==e&&(n=t);n!=-1&&(o.splice(n,1),plus.storage.setItem(h,JSON.stringify(o)))}}function o(e){if(null==e)return null;e=w+c.getRelativePathKey(e);var o=plus.storage.getItem(e);try{null!=o&&(o=JSON.parse(o))}catch(a){}return o}function a(o){if(null==o)return null;e(o),o=w+c.getRelativePathKey(o);plus.storage.removeItem(o)}function n(){c.plusReady(function(){var e=plus.storage.getItem(h);if(null!=e){try{e=JSON.parse(e)}catch(o){}if(Array.isArray(e))for(var n=0;n<e.length;n++)a(e[n])}})}function t(e){var o=null;if(f.getRelativePathFromLoadUrlCallback&&"function"==typeof f.getRelativePathFromLoadUrlCallback)o=f.getRelativePathFromLoadUrlCallback(e);else{var a=e.substring(e.lastIndexOf(".")+1,e.length);a=a||"file";var n=/[&\|\\\*^%$#@\-:.?\/=!]/g,t=e.replace(n,"");t=t.trim(),t.length>100&&(t=t.substr(t.length-100,t.length));var l=t+"."+a;o=f.downloadStoragePath+l}return o}function l(e){var a=o(e);return!(null==a||!a.time)&&(a.time=parseInt(a.time,10),(new Date).valueOf()-a.time>f.fileCacheTimeStamp)}function r(e,o){if(o=o||{},1==c.isNetWorkCanUse()){var a=t(e),n=c.getRelativePathKey(a);if(k&&k[n]&&Array.isArray(k[n]))return k[n].push(o),void(o.beforeDownload&&o.beforeDownload());k[n]=[],k[n].push(o),u(e,o)}else o.errorDownload&&o.errorDownload("下载失败:没有网络!,url:"+e)}function u(e,o){var a=t(e);if(null!=a){o=o||{};var n={filename:a,timeout:f.timeout,retryInterval:f.retryInterval},l=e;e=c.changImgUrlTypeWithRandomKey(e),o.beforeDownload&&o.beforeDownload();var r=plus.downloader.createDownload(e,n,function(e,o){200==o?i(l,!0):(null!=a&&d.delFile(a),i(l,!1)),m.currentTaskCount--,p[r.url]=null,s()}),u=0;r.addEventListener("statechanged",function(e,a){switch(e.state){case 1:o.downloading&&o.downloading(0,"开始下载...");break;case 2:o.downloading&&o.downloading(0,"已连接到服务器");break;case 3:if(0!=e.totalSize){var n=e.downloadedSize/e.totalSize*100;n=Math.round(n),n-u>=f.ListenerProgressStep&&(u=n,o.downloading&&o.downloading(parseInt(n),"下载中"))}break;case 4:o.downloading&&o.downloading(100,"下载完成100%")}}),m.queue.push({task:r,callbacks:o}),s()}}function i(e,o){var a=t(e),n=c.getRelativePathKey(a);if(k&&k[n]){var l=k[n];if(Array.isArray(l))for(var r=0;r<l.length;r++)1==o?l[r].successDownload&&l[r].successDownload(a,o):l[r].errorDownload&&l[r].errorDownload("下载失败",o);else 1==o?l.successDownload&&l.successDownload(a,o):l.errorDownload&&l.errorDownload("下载失败",o);k[n]=null}}function s(){for(var e in p)p[e]&&p[e].timeBegin&&(new Date).valueOf()-p[e].timeBegin>f.maxTimeSingleDownloadTaskSpend&&(p[e].taskObj&&p[e].taskObj.abort&&p[e].taskObj.abort(),m.currentTaskCount--,p[e]=null,i(e,!1));if(m.currentTaskCount<f.concurrentDownloadCount&&m.queue.length>0){var o=m.queue.shift(),a=o.task;a.start(),m.currentTaskCount++,p[a.url]={taskObj:a,timeBegin:(new Date).valueOf()}}}var c=require("CommonTools_Core"),d=require("FileTools_Core"),f={downloadStoragePath:"_downloads/downloadFiles/",fileCacheTimeStamp:864e5,concurrentDownloadCount:3,timeout:3,retryInterval:3,maxTimeSingleDownloadTaskSpend:1e4,getRelativePathFromLoadUrlCallback:null,ListenerProgressStep:5},g={};for(var v in f)g[v]=f[v];var w="downloadFile_SessionKey_util_caches_",h="downloadFile_SessionKey_util_Manager",k={},m={queue:[],currentTaskCount:0},p={};exports.setOptions=function(e){if(e)for(var o in f)void 0!==e[o]&&(f[o]=e[o])},exports.restoreOptions=function(){g&&(f=g)},exports.clearAllLocalFileCache=function(e,o){c.plusReady(function(){var a=plus.io.convertLocalFileSystemURL(f.downloadStoragePath);a="file://"+a,n(),plus.io.resolveLocalFileSystemURL(a,function(a){a.removeRecursively(function(){e&&"function"==typeof e&&e("清除本地缓存成功!路径:"+f.downloadStoragePath)},function(){o&&"function"==typeof o&&o("清除本地缓存失败!路径:"+f.downloadStoragePath)})},function(e){o&&"function"==typeof o&&o("打开本地缓存目录失败!"+f.downloadStoragePath)})})},exports.clearNetUrlFileCache=function(e,o,n){c.plusReady(function(){a(e),d.delFile(t(e),o,n)})},exports.abortTaskByUrl=function(e){p[e]&&p[e].taskObj&&p[e].taskObj.abort&&p[e].taskObj.abort(),m.currentTaskCount--,p[e]=null,i(e,!1);for(var o=0;o<m.queue.length;o++)m.queue[o].task&&m.queue[o].task.url==e&&(m.queue[o].callbacks&&m.queue[o].callbacks.errorDownload&&m.queue[o].callbacks.errorDownload("下载队列中的任务被外部强行终结,url:"+e),m.queue.splice(o,1))},exports.abortAllTask=function(){for(var e in p)p[e].taskObj&&p[e].taskObj.abort&&p[e].taskObj.abort(),p[e]=null,i(e,!1);for(var o=0;o<m.queue.length;o++)m.queue[o].task&&m.queue[o].callbacks&&m.queue[o].callbacks.errorDownload&&m.queue[o].callbacks.errorDownload("下载队列中的任务被外部强行终结,url:"+loadUrl);m.queue=[],m.currentTaskCount=0},exports.downloadFileWidthLocalCache=function(e,o,a){null!=e&&(a="boolean"!=typeof a||a,o=o||{},c.plusReady(function(){var n=t(e),u=/[\u4E00-\u9FA5]/g,i=e.replace(u,"chineseRemoveAfter");i.indexOf("chineseRemoveAfter")!=-1&&(e=encodeURI(e)),0==l(e)&&1==a?plus.io.resolveLocalFileSystemURL(n,function(e){o.successDownload&&o.successDownload(n,!0)},function(a){r(e,o)}):plus.io.resolveLocalFileSystemURL(n,function(a){d.delFile(n,function(){r(e,o)},function(){console.error("下载文件错误:删除本地已有文件时失败!"),r(e,o)})},function(a){r(e,o)})}))}});