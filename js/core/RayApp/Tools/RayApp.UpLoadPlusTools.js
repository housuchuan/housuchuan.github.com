define(function(require,exports,module){"use strict";function a(){for(var a in t)t[a]&&t[a].timeBegin&&(new Date).valueOf()-t[a].timeBegin>e.maxTimeSingleTaskSpend&&(t[a].taskObj&&t[a].taskObj.abort&&t[a].taskObj.abort(),t[a].callbacks&&t[a].callbacks.errorCallback&&t[a].callbacks.errorCallback("上传错误:上传超时,被强行终结!"),r.currentTaskCount--,t[a]=null);if(r.currentTaskCount<e.concurrentCount&&r.queue.length>0){var l=r.queue.shift(),c=l.task;c.start(),r.currentTaskCount++,t[c.url]={taskObj:c,timeBegin:(new Date).valueOf(),callbacks:l.callbacks}}}var l=require("CommonTools_Core"),e={method:"POST",timeout:15,retry:2,data:{},files:null,successCallback:l.noop,errorCallback:l.noop,beforeUploadCallback:l.noop,uploadingCallback:l.noop,concurrentCount:3,maxTimeSingleTaskSpend:1e4,ListenerProgressStep:5},r={queue:[],currentTaskCount:0},t={};exports.upLoadFiles=function(c){var u=l.extend(!0,{},e,c);if(!u.url)return void console.log("上传Url为空,无法上传");u.beforeUploadCallback&&u.beforeUploadCallback();var o=plus.uploader.createUpload(u.url,u,function(l,e){if(200==e){if(u.successCallback&&"function"==typeof u.successCallback){var c=null;try{c=JSON.parse(o.responseText)}catch(s){}u.successCallback(c)}}else u.errorCallback&&"function"==typeof u.errorCallback&&u.errorCallback(e);r.currentTaskCount--,t[o.url]=null,a()});if("string"==typeof u.data)try{u.data=JSON.parse(u.data)}catch(s){}for(var n in u.data)o.addData(n,u.data[n]);if(u.files)for(var k=0;k<u.files.length;k++){var b=u.files[k];console.log("添加文件:"+JSON.stringify(b)),o.addFile(b.path,{key:b.name})}o.taskId=u.id||u.url;var i=0;return o.addEventListener("statechanged",function(a,l){switch(a.state){case 1:u.uploadingCallback&&u.uploadingCallback(0,"开始下载...");break;case 2:u.uploadingCallback&&u.uploadingCallback(0,"已连接到服务器");break;case 3:if(0!=a.totalSize){var e=a.uploadedSize/a.totalSize*100;e=Math.round(e),e-i>=u.ListenerProgressStep&&(i=e,u.uploadingCallback&&u.uploadingCallback(parseInt(e),"下载中"))}break;case 4:u.uploadingCallback&&u.uploadingCallback(100,"下载完成100%")}}),r.queue.push({task:o,callbacks:u}),a(),o},exports.abortAllTask=function(){for(var a in t)t[a].taskObj&&t[a].taskObj.abort&&t[a].taskObj.abort(),t[a].callbacks&&t[a].callbacks.errorCallback&&t[a].callbacks.errorCallback("上传任务被外部强行终结,url:"+a),t[a]=null;for(var l=0;l<r.queue.length;l++)r.queue[l].task&&r.queue[l].callbacks&&r.queue[l].callbacks.errorCallback&&r.queue[l].callbacks.errorCallback("上传队列中的任务被外部强行终结,url:"+r.queue[l].task.url);r.queue=[],r.currentTaskCount=0},exports.abortTaskById=function(a){for(var l in t)t[l]&&t[l].taskObj&&t[l].taskObj.taskId==a&&(t[l].taskObj.abort&&t[l].taskObj.abort(),r.currentTaskCount--,t[l].callbacks&&t[l].callbacks.errorCallback&&t[l].callbacks.errorCallback("上传任务被外部强行终结,id:"+a),t[l]=null);for(var e=0;e<r.queue.length;e++)r.queue[e].task&&r.queue[e].task.taskId==a&&(r.queue[e].callbacks&&r.queue[e].callbacks.errorCallback&&r.queue[e].callbacks.errorCallback("上传队列中的任务被外部强行终结,id:"+a),r.queue.splice(e,1))}});